# ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

## âŒ é—®é¢˜ï¼šç­¾ååªç”Ÿæˆäº† x-tï¼Œæ²¡æœ‰ x-s

### ğŸ“‹ é—®é¢˜æè¿°

å½“è°ƒç”¨ `/sign` æ¥å£æ—¶ï¼Œè¿”å›çš„ JSON ä¸­ï¼š
- âœ… `x-t` å­˜åœ¨ä¸”æœ‰å€¼
- âŒ `x-s` ä¸ºç©ºæˆ–ä¸å­˜åœ¨

```json
{
  "x-t": "1234567890",
  "x-s": ""  // â† é—®é¢˜ï¼šåº”è¯¥æ˜¯ä¸€ä¸ªé•¿å­—ç¬¦ä¸²
}
```

---

## ğŸ” æ’æŸ¥æ­¥éª¤

### æ­¥éª¤ 1: è¿è¡Œè¯Šæ–­å·¥å…·

```bash
# ä½¿ç”¨è‡ªåŠ¨è¯Šæ–­å·¥å…·
python diagnose_sign_server.py
```

è¿™ä¸ªå·¥å…·ä¼šï¼š
- æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
- æµ‹è¯•å¤šä¸ªç­¾ååœºæ™¯
- æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- ç»™å‡ºå…·ä½“çš„ä¿®å¤å»ºè®®

---

### æ­¥éª¤ 2: æ£€æŸ¥ Render æ—¥å¿—

1. ç™»å½• [Render Dashboard](https://dashboard.render.com)
2. é€‰æ‹©ä½ çš„ç­¾åæœåŠ¡å™¨
3. ç‚¹å‡» **Logs** æ ‡ç­¾
4. æŸ¥çœ‹æ—¥å¿—ä¸­çš„å…³é”®ä¿¡æ¯ï¼š

#### âœ… æ­£å¸¸æ—¥å¿—åº”è¯¥åŒ…å«ï¼š

```
âœ… æµè§ˆå™¨å·²ç”Ÿæˆ a1: xxxxxxxxxxxx...
âœ… æµè§ˆå™¨åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç­¾åè¯·æ±‚
[å°è¯• 1/10] åŸå§‹è¿”å›å€¼: {'X-s': 'xxxx', 'X-t': 1234567890}
[å°è¯• 1/10] âœ… ç­¾åç”ŸæˆæˆåŠŸ
   x-s: xxxxxxxxxxxx...
   x-t: 1234567890
```

#### âŒ å¼‚å¸¸æ—¥å¿—å¯èƒ½æ˜¾ç¤ºï¼š

```
âš ï¸ stealth.js ä¸‹è½½å¤±è´¥
âŒ æœªèƒ½è·å–åˆ° a1 cookie
[å°è¯• 1/10] âš ï¸ x-s å­—æ®µä¸ºç©º
window._webmsxyw is not a function
```

---

### æ­¥éª¤ 3: å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆ

#### ğŸ”§ åŸå›  1: æµè§ˆå™¨è¿˜åœ¨åˆå§‹åŒ–

**ç—‡çŠ¶ï¼š**
- æœåŠ¡åˆšå¯åŠ¨æˆ–åˆšä»ä¼‘çœ å”¤é†’
- `/health` è¿”å› 503 æˆ– `browser_ready: false`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ç­‰å¾… 1-2 åˆ†é’Ÿï¼Œç„¶åé‡è¯•
curl https://your-server.onrender.com/health

# å¦‚æœ browser_ready=trueï¼Œå†æµ‹è¯•ç­¾å
curl -X POST https://your-server.onrender.com/sign \
  -H "Content-Type: application/json" \
  -d '{"uri":"/api/sns/web/v1/user_posted","data":null}'
```

---

#### ğŸ”§ åŸå›  2: stealth.js ä¸‹è½½å¤±è´¥

**ç—‡çŠ¶ï¼š**
- æ—¥å¿—æ˜¾ç¤º "stealth.js ä¸‹è½½å¤±è´¥"
- ç­¾åè¿”å›ä½† x-s ä¸ºç©º

**è§£å†³æ–¹æ¡ˆï¼š**

åœ¨ `sign-server/` ç›®å½•ä¸‹æ‰‹åŠ¨åˆ›å»º `stealth.min.js` æ–‡ä»¶ï¼š

```bash
cd sign-server

# ä¸‹è½½ stealth.js
curl -o stealth.min.js https://cdn.jsdelivr.net/gh/requireCool/stealth.min.js/stealth.min.js

# æäº¤åˆ° Git
git add stealth.min.js
git commit -m "æ·»åŠ  stealth.js æ–‡ä»¶"
git push
```

ç„¶ååœ¨ Dockerfile ä¸­æ·»åŠ ï¼š

```dockerfile
# å¤åˆ¶ stealth.js
COPY stealth.min.js .
```

---

#### ğŸ”§ åŸå›  3: å°çº¢ä¹¦é¡µé¢åŠ è½½ä¸å®Œæ•´

**ç—‡çŠ¶ï¼š**
- a1 cookie å­˜åœ¨
- ä½†ç­¾åå­—æ®µä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆï¼š**

å¢åŠ ç­‰å¾…æ—¶é—´ï¼Œä¿®æ”¹ `sign_server.py` ç¬¬ 145 è¡Œï¼š

```python
# åŸä»£ç 
time.sleep(1)

# æ”¹ä¸º
time.sleep(3)  # å¢åŠ åˆ° 3 ç§’
```

---

#### ğŸ”§ åŸå›  4: Playwright ç¯å¢ƒé—®é¢˜

**ç—‡çŠ¶ï¼š**
- Docker æ„å»ºæˆåŠŸ
- ä½†æµè§ˆå™¨æ— æ³•å¯åŠ¨

**è§£å†³æ–¹æ¡ˆï¼š**

ç¡®è®¤ Dockerfile ä½¿ç”¨æ­£ç¡®çš„åŸºç¡€é•œåƒï¼š

```dockerfile
# ä½¿ç”¨å®˜æ–¹ Playwright é•œåƒ
FROM mcr.microsoft.com/playwright/python:v1.48.0-jammy
```

å¦‚æœè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå°è¯•ï¼š

```dockerfile
# ä½¿ç”¨æ›´ç¨³å®šçš„ Ubuntu åŸºç¡€é•œåƒ
FROM mcr.microsoft.com/playwright/python:v1.48.0-focal
```

---

#### ğŸ”§ åŸå›  5: å†…å­˜ä¸è¶³ï¼ˆå…è´¹å¥—é¤é™åˆ¶ï¼‰

**ç—‡çŠ¶ï¼š**
- æœåŠ¡é¢‘ç¹é‡å¯
- æµè§ˆå™¨å´©æºƒ
- æ—¥å¿—ä¸­æœ‰ Out of Memory é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**

1. **ä¸´æ—¶æ–¹æ¡ˆ**ï¼šå‡å°‘å¹¶å‘è¯·æ±‚ï¼Œä¸€æ¬¡åªå‘ä¸€ä¸ªè¯·æ±‚

2. **é•¿æœŸæ–¹æ¡ˆ**ï¼šå‡çº§åˆ°ä»˜è´¹å¥—é¤
   - Render Starter Plan: $7/æœˆï¼Œ512MB RAM
   - æ¨è: Standard Plan: $25/æœˆï¼Œ2GB RAM

---

## ğŸ› ï¸ è°ƒè¯•æ¨¡å¼

### å¯ç”¨è¯¦ç»†æ—¥å¿—

å·²åœ¨æœ€æ–°ä»£ç ä¸­æ·»åŠ ï¼Œä¼šè‡ªåŠ¨è¾“å‡ºï¼š
- åŸå§‹è¿”å›å€¼
- è¿”å›å€¼ç±»å‹
- æ‰€æœ‰å­—æ®µçš„é”®å’Œå€¼

### æœ¬åœ°æµ‹è¯•

å¦‚æœ Render ä¸Šä¸€ç›´æœ‰é—®é¢˜ï¼Œå¯ä»¥æœ¬åœ°è¿è¡Œæµ‹è¯•ï¼š

```bash
# 1. å®‰è£…ä¾èµ–
cd sign-server
pip install -r requirements.txt
playwright install chromium

# 2. æœ¬åœ°è¿è¡Œ
python sign_server.py

# 3. æµ‹è¯•ç­¾å
curl -X POST http://localhost:5005/sign \
  -H "Content-Type: application/json" \
  -d '{"uri":"/api/sns/web/v1/user_posted","data":null}'
```

å¦‚æœæœ¬åœ°æ­£å¸¸ä½† Render ä¸æ­£å¸¸ï¼Œè¯´æ˜æ˜¯éƒ¨ç½²ç¯å¢ƒé—®é¢˜ã€‚

---

## ğŸ“Š å®Œæ•´æµ‹è¯•æµç¨‹

```bash
# 1. æ›´æ–°ä»£ç 
git pull

# 2. éƒ¨ç½²åˆ° Renderï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰
# ç­‰å¾… 3-5 åˆ†é’Ÿæ„å»ºå®Œæˆ

# 3. è¿è¡Œæ”¹è¿›çš„æµ‹è¯•è„šæœ¬
python test_deployment.py

# 4. æŸ¥çœ‹è¯¦ç»†è¾“å‡º
# ç°åœ¨ä¼šæ˜¾ç¤ºå®Œæ•´çš„å“åº” JSON

# 5. å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¿è¡Œè¯Šæ–­
python diagnose_sign_server.py

# 6. æŸ¥çœ‹ Render æ—¥å¿—
# å¤åˆ¶å…³é”®é”™è¯¯ä¿¡æ¯
```

---

## ğŸš¨ ç´§æ€¥ä¿®å¤

å¦‚æœæœåŠ¡å®Œå…¨ä¸å¯ç”¨ï¼Œå¿«é€Ÿä¿®å¤æ­¥éª¤ï¼š

### æ–¹æ¡ˆ A: é‡å¯æœåŠ¡

åœ¨ Render Dashboardï¼š
1. ç‚¹å‡»æœåŠ¡åç§°
2. ç‚¹å‡»å³ä¸Šè§’ **Manual Deploy** â†’ **Clear build cache & deploy**

### æ–¹æ¡ˆ B: å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬

```bash
# æŸ¥çœ‹å†å²æäº¤
git log --oneline -10

# å›æ»šåˆ°ä¸Šä¸€ä¸ªå·¥ä½œçš„ç‰ˆæœ¬
git revert HEAD
git push
```

### æ–¹æ¡ˆ C: ä½¿ç”¨å¤‡ç”¨é…ç½®

```bash
# ä½¿ç”¨å¤‡ç”¨çš„ Python ç¯å¢ƒé…ç½®
cp sign-server/render.yaml.backup sign-server/render.yaml
git add sign-server/render.yaml
git commit -m "åˆ‡æ¢åˆ° Python ç¯å¢ƒé…ç½®"
git push
```

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **Render æ—¥å¿—**ï¼ˆæœ€è¿‘ 100 è¡Œï¼‰
2. **è¯Šæ–­å·¥å…·è¾“å‡º**
3. **æµ‹è¯•è„šæœ¬å®Œæ•´è¾“å‡º**
4. **Render æœåŠ¡ URL**

æˆ‘ä¼šå¸®ä½ å…·ä½“åˆ†æé—®é¢˜ï¼

---

## âœ… éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œè¿è¡Œå®Œæ•´æµ‹è¯•ï¼š

```bash
# è¿è¡Œæµ‹è¯•
python test_deployment.py
```

æˆåŠŸæ ‡å¿—ï¼š
- âœ… ç­¾åæœåŠ¡å™¨æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… x-s å’Œ x-t éƒ½æœ‰å€¼
- âœ… å“åº”æ—¶é—´ < 5 ç§’ï¼ˆé¦–æ¬¡å¯èƒ½è¾ƒæ…¢ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [TEST.md](./TEST.md) - éƒ¨ç½²æµ‹è¯•æŒ‡å—
- [Render æ–‡æ¡£](https://render.com/docs)
- [Playwright æ–‡æ¡£](https://playwright.dev/python/)
- [å°çº¢ä¹¦ API](https://github.com/ReaJason/xhs)
