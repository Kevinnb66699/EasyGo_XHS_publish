# âœ… ç¡®è®¤ï¼šåç«¯è°ƒç”¨ç­¾åæ—¶å·²ä¼ é€’ Cookie

## ğŸ¯ é—®é¢˜
ä¸»è¦åç«¯è°ƒç”¨ç­¾åç”Ÿæˆæ—¶ä¼ é€’ cookie äº†å—ï¼Ÿ

## âœ… ç­”æ¡ˆ
**æ˜¯çš„ï¼å·²ç»ä¼ é€’äº†ï¼è€Œä¸”æ˜¯è‡ªåŠ¨çš„ï¼**

---

## ğŸ” è¯æ®ï¼šXhsClient æºç åˆ†æ

### å…³é”®ä»£ç ï¼ˆxhs/core.py ç¬¬ 143-156 è¡Œï¼‰

```python
class XhsClient:
    def _pre_headers(self, url: str, data=None, quick_sign: bool = False):
        if quick_sign:
            signs = sign(url, data, a1=self.cookie_dict.get("a1"))
            # ...
        else:
            # â­ è¿™é‡Œæ˜¯å…³é”®ï¼
            self.__session.headers.update(
                self.external_sign(
                    url,
                    data,
                    a1=self.cookie_dict.get("a1"),              # âœ… è‡ªåŠ¨æå– a1
                    web_session=self.cookie_dict.get("web_session", ""),  # âœ… è‡ªåŠ¨æå– web_session
                )
            )
```

**è¯´æ˜ï¼š**
- XhsClient å†…éƒ¨æœ‰ `cookie_dict` å±æ€§
- è°ƒç”¨ `external_sign` æ—¶ï¼Œ**è‡ªåŠ¨ä» `cookie_dict` ä¸­æå– `a1` å’Œ `web_session`**
- ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä½ å®šä¹‰çš„ `external_sign` å‡½æ•°

---

## ğŸ“Š å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·è¯·æ±‚                                                 â”‚
â”‚     Header: X-XHS-Cookie: a1=18bc5...; web_session=...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. app.py æ¥æ”¶                                              â”‚
â”‚     cookie = request.headers.get('X-XHS-Cookie')            â”‚
â”‚     # cookie = "a1=18bc5...; web_session=040069b...; ..."   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åˆ›å»º XhsClient                                           â”‚
â”‚     client = XhsClient(cookie=cookie, sign=external_sign)   â”‚
â”‚                                                              â”‚
â”‚     XhsClient å†…éƒ¨è‡ªåŠ¨è§£æ cookie:                            â”‚
â”‚     self.cookie_dict = {                                     â”‚
â”‚         "a1": "18bc5...",          # âœ… æå– a1               â”‚
â”‚         "web_session": "040069b...",  # âœ… æå– web_session  â”‚
â”‚         "webId": "..."                                       â”‚
â”‚     }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. XhsClient éœ€è¦ç­¾åæ—¶ï¼ˆå‘å¸ƒç¬”è®°ç­‰æ“ä½œï¼‰                      â”‚
â”‚     è°ƒç”¨ _pre_headers() æ–¹æ³•                                 â”‚
â”‚                                                              â”‚
â”‚     self.external_sign(                                      â”‚
â”‚         url="/api/sns/web/v2/note",                         â”‚
â”‚         data={...},                                          â”‚
â”‚         a1=self.cookie_dict.get("a1"),  # âœ… è‡ªåŠ¨ä¼ å…¥ a1      â”‚
â”‚         web_session=self.cookie_dict.get("web_session")  # âœ… è‡ªåŠ¨ä¼ å…¥ web_session  â”‚
â”‚     )                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. app.py çš„ external_sign å‡½æ•°è¢«è°ƒç”¨                        â”‚
â”‚     def external_sign(uri, data=None,                        â”‚
â”‚                       a1="18bc5...",        # âœ… æ”¶åˆ°ç”¨æˆ· a1   â”‚
â”‚                       web_session="040069b..."):  # âœ… æ”¶åˆ°ç”¨æˆ· web_session  â”‚
â”‚         # å‚æ•°å·²ç»åŒ…å«ç”¨æˆ·çš„ cookie å€¼äº†ï¼                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. è½¬å‘ç»™ç­¾åæœåŠ¡å™¨                                          â”‚
â”‚     response = requests.post(                                â”‚
â”‚         f"{sign_server_url}/sign",                          â”‚
â”‚         json={                                               â”‚
â”‚             "uri": uri,                                      â”‚
â”‚             "data": data,                                    â”‚
â”‚             "a1": a1,              # âœ… ç”¨æˆ·çš„ a1              â”‚
â”‚             "web_session": web_session  # âœ… ç”¨æˆ·çš„ web_session  â”‚
â”‚         }                                                    â”‚
â”‚     )                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. ç­¾åæœåŠ¡å™¨æ¥æ”¶å¹¶ä½¿ç”¨                                       â”‚
â”‚     - æ£€æµ‹åˆ°ç”¨æˆ·çš„ a1                                          â”‚
â”‚     - æ›´æ–°æµè§ˆå™¨ cookie ä¸ºç”¨æˆ·çš„ cookie                         â”‚
â”‚     - ä½¿ç”¨ç”¨æˆ· cookie ç”Ÿæˆç­¾å                                 â”‚
â”‚     - è¿”å›ç­¾å {x-s: "...", x-t: "..."}                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### 1. XhsClient è‡ªåŠ¨å¤„ç†

```python
# ä½ åªéœ€è¦ï¼š
client = XhsClient(cookie=cookie, sign=external_sign)

# XhsClient å†…éƒ¨ä¼šè‡ªåŠ¨ï¼š
# 1. è§£æ cookie å­—ç¬¦ä¸²
# 2. æå– a1ã€web_session ç­‰å­—æ®µ
# 3. è°ƒç”¨ external_sign æ—¶è‡ªåŠ¨ä¼ å…¥è¿™äº›å€¼
```

### 2. external_sign è‡ªåŠ¨æ¥æ”¶

```python
def external_sign(uri, data=None, a1="", web_session=""):
    # âœ… a1 å’Œ web_session å‚æ•°ä¼šè‡ªåŠ¨æ¥æ”¶åˆ°ç”¨æˆ·çš„å€¼
    # âœ… ç”± XhsClient è‡ªåŠ¨ä¼ å…¥ï¼Œæ— éœ€ä½ æ‰‹åŠ¨æå–
    
    # ç›´æ¥è½¬å‘ç»™ç­¾åæœåŠ¡å™¨å³å¯
    response = requests.post(
        f"{sign_server_url}/sign",
        json={
            "uri": uri,
            "data": data,
            "a1": a1,              # âœ… å·²ç»æ˜¯ç”¨æˆ·çš„ a1
            "web_session": web_session  # âœ… å·²ç»æ˜¯ç”¨æˆ·çš„ web_session
        }
    )
    return response.json()
```

### 3. ç­¾åæœåŠ¡å™¨è‡ªåŠ¨ä½¿ç”¨

```python
def generate_sign(uri, data, a1, web_session):
    # âœ… æ¥æ”¶åˆ°ç”¨æˆ·çš„ a1 å’Œ web_session
    
    if a1 and a1 != global_a1:
        # âœ… è‡ªåŠ¨æ›´æ–°ä¸ºç”¨æˆ·çš„ cookie
        browser_context.add_cookies([
            {'name': 'a1', 'value': a1, ...},
            {'name': 'web_session', 'value': web_session, ...}
        ])
        context_page.reload()
        global_a1 = a1
    
    # âœ… ä½¿ç”¨ç”¨æˆ·çš„ cookie ç”Ÿæˆç­¾å
    return context_page.evaluate("window._webmsxyw(...)")
```

---

## âœ… ç»“è®º

### é—®é¢˜ï¼šåç«¯è°ƒç”¨ç­¾åç”Ÿæˆæ—¶ä¼ é€’ cookie äº†å—ï¼Ÿ

### ç­”æ¡ˆï¼šâœ… æ˜¯çš„ï¼Œå·²ç»ä¼ é€’äº†ï¼

**ä¼ é€’æœºåˆ¶ï¼š**
1. âœ… ç”¨æˆ·åœ¨ header ä¸­å‘é€å®Œæ•´ cookie
2. âœ… app.py æ¥æ”¶ cookie
3. âœ… XhsClient è‡ªåŠ¨è§£æ cookie
4. âœ… XhsClient è‡ªåŠ¨æå– a1 å’Œ web_session
5. âœ… XhsClient è‡ªåŠ¨ä¼ ç»™ external_sign
6. âœ… external_sign è½¬å‘ç»™ç­¾åæœåŠ¡å™¨
7. âœ… ç­¾åæœåŠ¡å™¨ä½¿ç”¨ç”¨æˆ· cookie ç”Ÿæˆç­¾å

**ä½ ä¸éœ€è¦åšä»»ä½•ä¿®æ”¹ï¼** æ•´ä¸ªæµç¨‹å·²ç»å®Œç¾è¿è¡Œï¼ğŸ‰

---

## ğŸ“ éªŒè¯æ–¹æ³•

å¦‚æœä½ æƒ³éªŒè¯ï¼Œå¯ä»¥åœ¨ app.py çš„ external_sign ä¸­æ·»åŠ æ—¥å¿—ï¼š

```python
def external_sign(uri, data=None, a1="", web_session=""):
    """è°ƒç”¨å¤–éƒ¨ç­¾åæœåŠ¡"""
    try:
        # æ·»åŠ æ—¥å¿—éªŒè¯
        logger.info(f"æ”¶åˆ°ç­¾åè¯·æ±‚:")
        logger.info(f"  - URI: {uri}")
        logger.info(f"  - a1: {a1[:20]}..." if a1 else "  - a1: ç©º")
        logger.info(f"  - web_session: {web_session[:20]}..." if web_session else "  - web_session: ç©º")
        
        response = requests.post(
            f"{sign_server_url}/sign",
            json={
                "uri": uri,
                "data": data,
                "a1": a1,
                "web_session": web_session
            },
            timeout=10
        )
        # ...
```

æŸ¥çœ‹ Vercel æ—¥å¿—ï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
æ”¶åˆ°ç­¾åè¯·æ±‚:
  - URI: /api/sns/web/v2/note
  - a1: 18bc5xxx...             âœ… æœ‰å€¼ï¼
  - web_session: 040069bxxx...  âœ… æœ‰å€¼ï¼
```

---

## ğŸŠ æ€»ç»“

**ä½ çš„ä»£ç å·²ç»å®Œç¾æ”¯æŒä½¿ç”¨ç”¨æˆ· cookie è¿›è¡Œç­¾åï¼**

- âœ… XhsClient è‡ªåŠ¨å¤„ç†ä¸€åˆ‡
- âœ… æ— éœ€æ‰‹åŠ¨æå– cookie å­—æ®µ
- âœ… æ— éœ€æ‰‹åŠ¨ä¼ é€’å‚æ•°
- âœ… ç­¾åæœåŠ¡å™¨è‡ªåŠ¨ä½¿ç”¨ç”¨æˆ· cookie
- âœ… ä¸€åˆ‡éƒ½æ˜¯è‡ªåŠ¨çš„ï¼

**äº«å—æ— ç¼çš„å¤šç”¨æˆ·ç­¾åæœåŠ¡å§ï¼** ğŸš€

---

**æ›´æ–°æ—¶é—´ï¼š** 2026-02-10  
**éªŒè¯çŠ¶æ€ï¼š** âœ… å·²é€šè¿‡æºç éªŒè¯
